<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="c++后台方向">
<meta property="og:type" content="website">
<meta property="og:title" content="條路自己揀，僕街唔好喊。">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="條路自己揀，僕街唔好喊。">
<meta property="og:description" content="c++后台方向">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="條路自己揀，僕街唔好喊。">
<meta name="twitter:description" content="c++后台方向">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>條路自己揀，僕街唔好喊。</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">條路自己揀，僕街唔好喊。</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/23/用select改进回射客户-服务器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Just_Lm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="條路自己揀，僕街唔好喊。">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/23/用select改进回射客户-服务器/" itemprop="url">用select改进回射客户/服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-23T16:15:28+08:00">
                2018-02-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p> 服务器端用select函数代替多进程实现并发，而客户端用select函数可对多个IO并发处理，不会像注释代码那样阻塞在fgets函数。</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> maxfd, fd_set *readset, fd_set *writeset, fd_set *exceptset,struct timeval *timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line">maxfd：被监听的文件描述符的总数，它比所有文件描述符集合中的文件描述符的最大值大<span class="number">1</span>，因为文件描述符是从<span class="number">0</span>开始计数的；</span><br><span class="line">readfds、writefds、exceptset：分别指向可读、可写和异常等事件对应的描述符集合。</span><br><span class="line">timeout:用于设置select函数的超时时间，即告诉内核select等待多长时间之后就放弃等待。timeout == <span class="literal">NULL</span> 表示等待无限长的时间</span><br><span class="line"></span><br><span class="line">timeval结构体定义如下：</span><br><span class="line">struct timeval</span><br><span class="line">&#123;      </span><br><span class="line">    <span class="keyword">long</span> tv_sec;   <span class="comment">/*秒 */</span></span><br><span class="line">    <span class="keyword">long</span> tv_usec;  <span class="comment">/*微秒 */</span>   </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">返回值：超时返回<span class="number">0</span>;失败返回<span class="number">-1</span>；成功返回大于<span class="number">0</span>的整数，这个整数表示就绪描述符的数目。</span><br><span class="line"></span><br><span class="line">以下介绍与select函数相关的常见的几个宏：</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;   </span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FD_ZERO</span><span class="params">(<span class="keyword">int</span> fd, fd_set *fdset)</span></span>;   <span class="comment">//一个 fd_set类型变量的所有位都设为 0</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FD_CLR</span><span class="params">(<span class="keyword">int</span> fd, fd_set *fdset)</span></span>;  <span class="comment">//清除某个位时可以使用</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FD_SET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *fd_set)</span></span>;   <span class="comment">//设置变量的某个位置位</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FD_ISSET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *fdset)</span></span>; <span class="comment">//测试某个位是否被置位</span></span><br></pre></td></tr></table></figure>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) do &#123;  perror(m); exit(EXIT_FAILURE); &#125;while(0);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> readn(<span class="keyword">int</span> fd,<span class="keyword">void</span> *buf,<span class="keyword">size_t</span> count)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;</span><br><span class="line">	<span class="keyword">ssize_t</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*) buf;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ((nread = read(fd, bufp, nleft) )&lt; <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (nread == <span class="number">0</span> )</span><br><span class="line">			 <span class="keyword">return</span> count - nleft;</span><br><span class="line">		</span><br><span class="line">		bufp += nread;</span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> writen(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;</span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;</span><br><span class="line">        <span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*) buf;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(nleft &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span> ((nwritten = write(fd, bufp, nleft) )&lt; <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nwritten  == <span class="number">0</span> )</span><br><span class="line">                         <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                bufp += nwritten;</span><br><span class="line">                nleft -= nwritten;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">ssize_t</span> recv_peek(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> ret = recv(sockfd,buf,len,MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> readline(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft= maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ret = recv_peek(sockfd,bufp,nleft);</span><br><span class="line">		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>) </span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		</span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;</span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (bufp[i] == <span class="string">'\n'</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				ret = readn(sockfd,bufp,i+<span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (ret != i+<span class="number">1</span>)</span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = readn(sockfd,bufp,nread);</span><br><span class="line">		<span class="keyword">if</span> (ret != nread)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_svr</span><span class="params">(<span class="keyword">int</span> conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	 <span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">         <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">         &#123;</span><br><span class="line">                <span class="built_in">memset</span>(recvbuf, <span class="number">0</span> , <span class="keyword">sizeof</span> recvbuf);  </span><br><span class="line">                <span class="keyword">int</span> ret = readline(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">                <span class="keyword">if</span> ( ret == <span class="number">-1</span>)  ERR_EXIT(<span class="string">"readline"</span>); </span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">0</span> )     </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"client_close\n"</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf,<span class="built_in">stdout</span>);</span><br><span class="line">                writen(conn,&amp;recvbuf,<span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_sigchld</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  	 <span class="comment">//wait(NULL)</span></span><br><span class="line">	<span class="keyword">while</span>(waitpid(<span class="number">-1</span>,<span class="literal">NULL</span>,WNOHANG) &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	signal(SIGCHLD,handle_sigchld); <span class="comment">//解决僵尸进程。</span></span><br><span class="line"><span class="comment">//	 signal(SIGCHLD,SIG_IGN);</span></span><br><span class="line"> 	<span class="keyword">int</span> listenfd;</span><br><span class="line">        <span class="keyword">if</span> ((listenfd = socket(PF_INET,SOCK_STREAM,IPPROTO_TCP)) &lt; <span class="number">0</span>)<span class="comment">//第三个参数也可直接是0</span></span><br><span class="line">		ERR_EXIT(<span class="string">"socket"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr,<span class="number">0</span>,<span class="keyword">sizeof</span> servaddr);</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = htons(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (setsockopt(listenfd,SOL_SOCKET,SO_REUSEADDR, &amp;on, <span class="keyword">sizeof</span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"setsockopt"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (bind(listenfd,(struct sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span> (servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"bind"</span>);</span><br><span class="line">	<span class="keyword">if</span> (listen(listenfd,SOMAXCONN) &lt; <span class="number">0</span> )</span><br><span class="line"> 		ERR_EXIT(<span class="string">"listen"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="keyword">sizeof</span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*	pid_t pid;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	while(1)</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">        	if ((conn = accept(listenfd,(struct sockaddr*)&amp;peeraddr,&amp;peerlen)) &lt; 0)</span></span><br><span class="line"><span class="comment">     			ERR_EXIT("accept");</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">		printf("ip = %s port = %d\n", inet_ntoa(peeraddr.sin_addr), ntohs(peeraddr.sin_port));</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">		pid = fork();</span></span><br><span class="line"><span class="comment">		if (pid == -1) ERR_EXIT("fork");</span></span><br><span class="line"><span class="comment">		if (pid == 0)</span></span><br><span class="line"><span class="comment">		&#123;</span></span><br><span class="line"><span class="comment">			close(listenfd);</span></span><br><span class="line"><span class="comment">			echo_svr(conn);</span></span><br><span class="line"><span class="comment">			exit(EXIT_SUCCESS);</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		else</span></span><br><span class="line"><span class="comment">			close(conn);</span></span><br><span class="line"><span class="comment">		</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">	<span class="keyword">int</span> client[FD_SETSIZE];  <span class="comment">//记录连接客户端的文件描述符</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> maxi = <span class="number">0</span>;  <span class="comment">//记录client数组有多少个连接客户端的文件描述符</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; FD_SETSIZE; i++)</span><br><span class="line">		client[i] = <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">int</span> nready;   <span class="comment">//记录select返回值</span></span><br><span class="line">	<span class="keyword">int</span> maxfd = listenfd;</span><br><span class="line">	fd_set rset;</span><br><span class="line">	fd_set allset; </span><br><span class="line">	FD_ZERO(&amp;rset);</span><br><span class="line">	FD_ZERO(&amp;allset);</span><br><span class="line">	FD_SET(listenfd, &amp;allset);</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		rset = allset;</span><br><span class="line">		nready = select(maxfd +<span class="number">1</span> , &amp;rset, <span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (nready == <span class="number">-1</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (errno == EINTR) </span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			ERR_EXIT(<span class="string">"select"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">0</span> )</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (FD_ISSET(listenfd, &amp;rset))</span><br><span class="line">		&#123;</span><br><span class="line">			peerlen = <span class="keyword">sizeof</span>(peeraddr);</span><br><span class="line">			<span class="keyword">if</span> ((conn = accept(listenfd,(struct sockaddr*)&amp;peeraddr,&amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">        	                ERR_EXIT(<span class="string">"accept"</span>);</span><br><span class="line">        		</span><br><span class="line">			<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; FD_SETSIZE; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (client[i] &lt; <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					client[i] = conn;</span><br><span class="line">					<span class="keyword">if</span> (i &gt; maxi) maxi = i;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (i == FD_SETSIZE)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"too many clients\n"</span>);</span><br><span class="line">				<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			&#125;</span><br><span class="line">	       <span class="built_in">printf</span>(<span class="string">"ip = %s port = %d\n"</span>, inet_ntoa(peeraddr.sin_addr), ntohs(peeraddr.sin_port));</span><br><span class="line">			</span><br><span class="line">			FD_SET(conn,&amp;allset);</span><br><span class="line">			<span class="keyword">if</span> (conn &gt; maxfd) maxfd = conn;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (--nready &lt;= <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; maxi; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			conn = client[i];</span><br><span class="line">			<span class="keyword">if</span> (conn == <span class="number">-1</span>) <span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">if</span> (FD_ISSET(conn,&amp;rset))</span><br><span class="line">			&#123;</span><br><span class="line">			    	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">			    	<span class="built_in">memset</span>(recvbuf, <span class="number">0</span> , <span class="keyword">sizeof</span> recvbuf);</span><br><span class="line">		                <span class="keyword">int</span> ret = readline(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">		                <span class="keyword">if</span> ( ret == <span class="number">-1</span>)  ERR_EXIT(<span class="string">"readline"</span>);</span><br><span class="line">		                <span class="keyword">if</span> (ret == <span class="number">0</span> )</span><br><span class="line">		                &#123;</span><br><span class="line">		                    <span class="built_in">printf</span>(<span class="string">"client_close\n"</span>);</span><br><span class="line">		                  	FD_CLR(conn, &amp;allset);</span><br><span class="line">				        	client[i] = <span class="number">-1</span>;</span><br><span class="line">		                &#125;</span><br><span class="line">		</span><br><span class="line">	</span><br><span class="line">		                <span class="built_in">fputs</span>(recvbuf,<span class="built_in">stdout</span>);</span><br><span class="line">		       	        writen(conn,&amp;recvbuf,<span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span> (--nready &lt;= <span class="number">0</span>)</span><br><span class="line">					 <span class="keyword">break</span>; </span><br><span class="line">			&#125;</span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>###　客户端</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) do &#123;  perror(m); exit(EXIT_FAILURE); &#125;while(0);</span></span><br><span class="line"><span class="keyword">ssize_t</span> readn(<span class="keyword">int</span> fd,<span class="keyword">void</span> *buf,<span class="keyword">size_t</span> count)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">size_t</span> nleft = count;</span><br><span class="line">        <span class="keyword">ssize_t</span> nread;</span><br><span class="line">        <span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*) buf;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(nleft &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span> ((nread = read(fd, bufp, nleft) )&lt; <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nread == <span class="number">0</span> )</span><br><span class="line">                         <span class="keyword">return</span> count - nleft;</span><br><span class="line"></span><br><span class="line">                bufp += nread;</span><br><span class="line">                nleft -= nread;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> writen(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">size_t</span> nleft = count;</span><br><span class="line">        <span class="keyword">ssize_t</span> nwritten;</span><br><span class="line">        <span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*) buf;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(nleft &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span> ((nwritten = write(fd, bufp, nleft) )&lt; <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nwritten  == <span class="number">0</span> )</span><br><span class="line">                         <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                bufp += nwritten;</span><br><span class="line">                nleft -= nwritten;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">ssize_t</span> recv_peek(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">int</span> ret = recv(sockfd,buf,len,MSG_PEEK);</span><br><span class="line">                <span class="keyword">if</span> (ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> readline(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="keyword">int</span> nread;</span><br><span class="line">        <span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">        <span class="keyword">int</span> nleft= maxline;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                ret = recv_peek(sockfd,bufp,nleft);</span><br><span class="line">                <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">                nread = ret;</span><br><span class="line">                <span class="keyword">int</span> i;</span><br><span class="line">                <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">if</span> (bufp[i] == <span class="string">'\n'</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                                ret = readn(sockfd,bufp,i+<span class="number">1</span>);</span><br><span class="line">                                <span class="keyword">if</span> (ret != i+<span class="number">1</span>)</span><br><span class="line">                                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                                <span class="keyword">return</span> ret;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (nread &gt; nleft)</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                nleft -= nread;</span><br><span class="line">                ret = readn(sockfd,bufp,nread);</span><br><span class="line">                <span class="keyword">if</span> (ret != nread)</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                bufp += nread;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_cli</span><span class="params">(<span class="keyword">int</span> sock)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*        char sendbuf[1024] = &#123;0&#125;;</span></span><br><span class="line"><span class="comment">        char recvbuf[1024] = &#123;0&#125;;</span></span><br><span class="line"><span class="comment">        while(fgets(sendbuf ,sizeof (sendbuf),stdin) != NULL)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">                writen(sock,sendbuf,strlen(sendbuf));</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                int ret = readline(sock, recvbuf, sizeof(recvbuf));</span></span><br><span class="line"><span class="comment">                if ( ret == -1)&#123;  ERR_EXIT("readline");&#125;</span></span><br><span class="line"><span class="comment">                else</span></span><br><span class="line"><span class="comment">                if (ret == 0 )</span></span><br><span class="line"><span class="comment">                &#123;</span></span><br><span class="line"><span class="comment">                        printf("server_close\n");</span></span><br><span class="line"><span class="comment">                        break;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                fputs(recvbuf,stdout);</span></span><br><span class="line"><span class="comment">                memset(sendbuf,0,sizeof sendbuf);</span></span><br><span class="line"><span class="comment">                memset(recvbuf,0,sizeof recvbuf);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        close(sock);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">	fd_set rset;</span><br><span class="line">	FD_ZERO(&amp;rset);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> nready;</span><br><span class="line">	<span class="keyword">int</span> maxfd;</span><br><span class="line">	<span class="keyword">int</span> fd_stdin = fileno(<span class="built_in">stdin</span>);</span><br><span class="line">	<span class="keyword">if</span> (fd_stdin &gt; sock)</span><br><span class="line">		maxfd = fd_stdin;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">		maxfd = sock;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		FD_SET(fd_stdin, &amp;rset);</span><br><span class="line">		FD_SET(sock, &amp;rset);</span><br><span class="line">		nready = select(maxfd +<span class="number">1</span>, &amp;rset,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">			ERR_EXIT(<span class="string">"select"</span>);</span><br><span class="line">		<span class="keyword">if</span> (nready == <span class="number">0</span> )</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> (FD_ISSET(sock,&amp;rset))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">int</span> ret = readline(sock, recvbuf, <span class="keyword">sizeof</span>(recvbuf));</span><br><span class="line">         		<span class="keyword">if</span> ( ret == <span class="number">-1</span>)&#123;  ERR_EXIT(<span class="string">"readline"</span>);&#125;</span><br><span class="line">           	        <span class="keyword">else</span></span><br><span class="line">               		 <span class="keyword">if</span> (ret == <span class="number">0</span> )</span><br><span class="line">               		 &#123;</span><br><span class="line">                        	<span class="built_in">printf</span>(<span class="string">"server_close\n"</span>);</span><br><span class="line">                	        <span class="keyword">break</span>;</span><br><span class="line">        	         &#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">                	<span class="built_in">fputs</span>(recvbuf,<span class="built_in">stdout</span>);</span><br><span class="line">	                <span class="built_in">memset</span>(recvbuf,<span class="number">0</span>,<span class="keyword">sizeof</span> recvbuf);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (FD_ISSET(fd_stdin, &amp;rset))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (fgets(sendbuf ,<span class="keyword">sizeof</span> (sendbuf),<span class="built_in">stdin</span>)== <span class="literal">NULL</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			writen(sock,sendbuf,<span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">			<span class="built_in">memset</span>(sendbuf,<span class="number">0</span>,<span class="keyword">sizeof</span> sendbuf);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	close(sock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="keyword">int</span> sock;</span><br><span class="line">        <span class="keyword">if</span> ((sock  = socket(PF_INET,SOCK_STREAM,IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"socket"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr,<span class="number">0</span>,<span class="keyword">sizeof</span> servaddr);</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = htons(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (connect(sock, (struct sockaddr*)&amp;servaddr,<span class="keyword">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"connext"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">localaddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> addrlen = <span class="keyword">sizeof</span>(localaddr);</span><br><span class="line">	<span class="keyword">if</span> ( getsockname(sock, (struct sockaddr*)&amp;localaddr, &amp;addrlen) &lt; <span class="number">0</span> )</span><br><span class="line">		ERR_EXIT(<span class="string">"getsockname"</span>);</span><br><span class="line"></span><br><span class="line">	 <span class="built_in">printf</span>(<span class="string">"ip = %s port = %d\n"</span>, inet_ntoa(localaddr.sin_addr), ntohs(localaddr.sin_port));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	echo_cli(sock);		</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/20/实现readline函数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Just_Lm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="條路自己揀，僕街唔好喊。">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/20/实现readline函数/" itemprop="url">实现readline函数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-20T18:42:24+08:00">
                2018-02-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>实现了readline函数，利用recv函数以及ＭＳＧ_ＰＥＥＫ标志。</p>
</blockquote>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) do &#123;  perror(m); exit(EXIT_FAILURE); &#125;while(0);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> readn(<span class="keyword">int</span> fd,<span class="keyword">void</span> *buf,<span class="keyword">size_t</span> count)　</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;</span><br><span class="line">	<span class="keyword">ssize_t</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*) buf;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ((nread = read(fd, bufp, nleft) )&lt; <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (nread == <span class="number">0</span> )</span><br><span class="line">			 <span class="keyword">return</span> count - nleft;</span><br><span class="line">		</span><br><span class="line">		bufp += nread;</span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> writen(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;</span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;</span><br><span class="line">        <span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*) buf;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(nleft &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span> ((nwritten = write(fd, bufp, nleft) )&lt; <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nwritten  == <span class="number">0</span> )</span><br><span class="line">                         <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                bufp += nwritten;</span><br><span class="line">                nleft -= nwritten;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">ssize_t</span> recv_peek(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)　　<span class="comment">//重新封装了recv函数</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> ret = recv(sockfd,buf,len,MSG_PEEK);  <span class="comment">//读取缓冲区，但不删除缓冲区</span></span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> readline(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)  </span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft= maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ret = recv_peek(sockfd,bufp,nleft);</span><br><span class="line">		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>) </span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		</span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;</span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (bufp[i] == <span class="string">'\n'</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				ret = readn(sockfd,bufp,i+<span class="number">1</span>);</span><br><span class="line">				<span class="keyword">if</span> (ret != i+<span class="number">1</span>)</span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = readn(sockfd,bufp,nread);</span><br><span class="line">		<span class="keyword">if</span> (ret != nread)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_service</span><span class="params">(<span class="keyword">int</span> conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	 <span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">         <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">         &#123;</span><br><span class="line">                <span class="built_in">memset</span>(recvbuf, <span class="number">0</span> , <span class="keyword">sizeof</span> recvbuf);  </span><br><span class="line">                <span class="keyword">int</span> ret = readline(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">                <span class="keyword">if</span> ( ret == <span class="number">-1</span>)  ERR_EXIT(<span class="string">"readline"</span>); </span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">0</span> )     </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"client_close\n"</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf,<span class="built_in">stdout</span>);</span><br><span class="line">                writen(conn,&amp;recvbuf,<span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="keyword">int</span> listenfd;</span><br><span class="line">        <span class="keyword">if</span> ((listenfd = socket(PF_INET,SOCK_STREAM,IPPROTO_TCP)) &lt; <span class="number">0</span>)<span class="comment">//第三个参数也可直接是0</span></span><br><span class="line">		ERR_EXIT(<span class="string">"socket"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr,<span class="number">0</span>,<span class="keyword">sizeof</span> servaddr);</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = htons(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (setsockopt(listenfd,SOL_SOCKET,SO_REUSEADDR, &amp;on, <span class="keyword">sizeof</span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"setsockopt"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (bind(listenfd,(struct sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span> (servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"bind"</span>);</span><br><span class="line">	<span class="keyword">if</span> (listen(listenfd,SOMAXCONN) &lt; <span class="number">0</span> )</span><br><span class="line"> 		ERR_EXIT(<span class="string">"listen"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="keyword">sizeof</span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">        	<span class="keyword">if</span> ((conn = accept(listenfd,(struct sockaddr*)&amp;peeraddr,&amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">     			ERR_EXIT(<span class="string">"accept"</span>);</span><br><span class="line">	</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"ip = %s port = %d\n"</span>, inet_ntoa(peeraddr.sin_addr), ntohs(peeraddr.sin_port));</span><br><span class="line">	</span><br><span class="line">		pid = fork();</span><br><span class="line">		<span class="keyword">if</span> (pid == <span class="number">-1</span>) ERR_EXIT(<span class="string">"fork"</span>);</span><br><span class="line">		<span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			close(listenfd);</span><br><span class="line">			do_service(conn);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			close(conn);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) do &#123;  perror(m); exit(EXIT_FAILURE); &#125;while(0);</span></span><br><span class="line"><span class="keyword">ssize_t</span> readn(<span class="keyword">int</span> fd,<span class="keyword">void</span> *buf,<span class="keyword">size_t</span> count)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">size_t</span> nleft = count;</span><br><span class="line">        <span class="keyword">ssize_t</span> nread;</span><br><span class="line">        <span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*) buf;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(nleft &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span> ((nread = read(fd, bufp, nleft) )&lt; <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nread == <span class="number">0</span> )</span><br><span class="line">                         <span class="keyword">return</span> count - nleft;</span><br><span class="line"></span><br><span class="line">                bufp += nread;</span><br><span class="line">                nleft -= nread;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> writen(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">size_t</span> nleft = count;</span><br><span class="line">        <span class="keyword">ssize_t</span> nwritten;</span><br><span class="line">        <span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*) buf;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(nleft &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span> ((nwritten = write(fd, bufp, nleft) )&lt; <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nwritten  == <span class="number">0</span> )</span><br><span class="line">                         <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                bufp += nwritten;</span><br><span class="line">                nleft -= nwritten;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">ssize_t</span> recv_peek(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">int</span> ret = recv(sockfd,buf,len,MSG_PEEK);</span><br><span class="line">                <span class="keyword">if</span> (ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> readline(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="keyword">int</span> nread;</span><br><span class="line">        <span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">        <span class="keyword">int</span> nleft= maxline;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                ret = recv_peek(sockfd,bufp,nleft);</span><br><span class="line">                <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">                nread = ret;</span><br><span class="line">                <span class="keyword">int</span> i;</span><br><span class="line">                <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">if</span> (bufp[i] == <span class="string">'\n'</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                                ret = readn(sockfd,bufp,i+<span class="number">1</span>);</span><br><span class="line">                                <span class="keyword">if</span> (ret != i+<span class="number">1</span>)</span><br><span class="line">                                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                                <span class="keyword">return</span> ret;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (nread &gt; nleft)</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                nleft -= nread;</span><br><span class="line">                ret = readn(sockfd,bufp,nread);</span><br><span class="line">                <span class="keyword">if</span> (ret != nread)</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                bufp += nread;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="keyword">int</span> sock;</span><br><span class="line">        <span class="keyword">if</span> ((sock  = socket(PF_INET,SOCK_STREAM,IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"socket"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr,<span class="number">0</span>,<span class="keyword">sizeof</span> servaddr);</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = htons(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (connect(sock, (struct sockaddr*)&amp;servaddr,<span class="keyword">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"connext"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">localaddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> addrlen = <span class="keyword">sizeof</span>(localaddr);</span><br><span class="line">	<span class="keyword">if</span> ( getsockname(sock, (struct sockaddr*)&amp;localaddr, &amp;addrlen) &lt; <span class="number">0</span> )</span><br><span class="line">		ERR_EXIT(<span class="string">"getsockname"</span>);</span><br><span class="line"></span><br><span class="line">	 <span class="built_in">printf</span>(<span class="string">"ip = %s port = %d\n"</span>, inet_ntoa(localaddr.sin_addr), ntohs(localaddr.sin_port));</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  	<span class="keyword">while</span>(fgets(sendbuf ,<span class="keyword">sizeof</span> (sendbuf),<span class="built_in">stdin</span>) != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		writen(sock,sendbuf,<span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">		</span><br><span class="line">                <span class="keyword">int</span> ret = readline(sock, recvbuf, <span class="keyword">sizeof</span>(recvbuf));</span><br><span class="line">                <span class="keyword">if</span> ( ret == <span class="number">-1</span>)&#123;  ERR_EXIT(<span class="string">"readline"</span>);&#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> (ret == <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"client_close\n"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf,<span class="built_in">stdout</span>);</span><br><span class="line">		<span class="built_in">memset</span>(sendbuf,<span class="number">0</span>,<span class="keyword">sizeof</span> sendbuf);</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf,<span class="number">0</span>,<span class="keyword">sizeof</span> recvbuf);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	close(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="获取本机ip地址列表及本机ip"><a href="#获取本机ip地址列表及本机ip" class="headerlink" title="获取本机ｉｐ地址列表及本机ｉｐ"></a>获取本机ｉｐ地址列表及本机ｉｐ</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) do &#123;  perror(m); exit(EXIT_FAILURE); &#125;while(0);</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getlocalip</span><span class="params">(<span class="keyword">char</span> *ip)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> host[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span> (gethostname(host,<span class="keyword">sizeof</span>(host)) &lt; <span class="number">0</span>)</span><br><span class="line">               <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hp</span>;</span></span><br><span class="line">	<span class="keyword">if</span> ((hp = gethostbyname(host)) == <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">strcpy</span>(ip,inet_ntoa(*(struct in_addr*)hp-&gt;h_addr_list[<span class="number">0</span>]));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> host[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">if</span> (gethostname(host,<span class="keyword">sizeof</span>(host)) &lt; <span class="number">0</span>)</span><br><span class="line">   		ERR_EXIT(<span class="string">"gethostname"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hp</span>;</span></span><br><span class="line">	<span class="keyword">if</span> ((hp = gethostbyname(host)) == <span class="literal">NULL</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"gethostbyname"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(hp-&gt;h_addr_list[i]!= <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%s\n"</span>,inet_ntoa(*(struct in_addr*)hp-&gt;h_addr_list[i]));</span><br><span class="line">		i++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> ip[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	getlocalip(ip);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"localip = %s\n"</span>,ip);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/20/回射客户-服务器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Just_Lm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="條路自己揀，僕街唔好喊。">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/20/回射客户-服务器/" itemprop="url">回射客户/服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-20T02:38:33+08:00">
                2018-02-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>功能：　客户端发送消息给服务端，服务端回射。<br>　　　　　　通过包头加上包体长度解决ｔｃｐ粘包问题。也用了定长包。<br>　　　　　  重写了ｒｅａｄ函数以及ｗｒｉｔｅ函数。</p>
</blockquote>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) do &#123;  perror(m); exit(EXIT_FAILURE); &#125;while(0);</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet</span>  //定义包头和包体。</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">int</span> len;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">ssize_t</span> readn(<span class="keyword">int</span> fd,<span class="keyword">void</span> *buf,<span class="keyword">size_t</span> count)　<span class="comment">//读取定长包</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;</span><br><span class="line">	<span class="keyword">ssize_t</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*) buf;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ((nread = read(fd, bufp, nleft) )&lt; <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (errno == EINTR) <span class="comment">//全局变量errno是记录系统的最后一次错误代码,一个int型的值.</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (nread == <span class="number">0</span> )</span><br><span class="line">			 <span class="keyword">return</span> count - nleft;</span><br><span class="line">		</span><br><span class="line">		bufp += nread;</span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> writen(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)　<span class="comment">//与ｒｅａｄｎ同理</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;</span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;</span><br><span class="line">        <span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*) buf;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(nleft &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span> ((nwritten = write(fd, bufp, nleft) )&lt; <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nwritten  == <span class="number">0</span> )</span><br><span class="line">                         <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                bufp += nwritten;</span><br><span class="line">                nleft -= nwritten;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_service</span><span class="params">(<span class="keyword">int</span> conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	 <span class="class"><span class="keyword">struct</span> <span class="title">packet</span> <span class="title">recvbuf</span>;</span></span><br><span class="line">	 <span class="keyword">int</span> n;</span><br><span class="line">         <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">         &#123;</span><br><span class="line">                <span class="built_in">memset</span>(&amp;recvbuf, <span class="number">0</span> , <span class="keyword">sizeof</span> recvbuf);  </span><br><span class="line">                <span class="keyword">int</span> ret = readn(conn, &amp;recvbuf.len, <span class="number">4</span>);　　<span class="comment">//先读取包头长度</span></span><br><span class="line">                <span class="keyword">if</span> ( ret == <span class="number">-1</span>) &#123; ERR_EXIT(<span class="string">"read"</span>); &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">	        	<span class="keyword">if</span> (ret &lt; <span class="number">4</span> )     </span><br><span class="line">	         	&#123;</span><br><span class="line">	        		<span class="built_in">printf</span>(<span class="string">"client_close\n"</span>);</span><br><span class="line">	        		<span class="keyword">break</span>;</span><br><span class="line">	        	&#125;</span><br><span class="line"></span><br><span class="line">	    	n = ntohl(recvbuf.len);</span><br><span class="line">	    	ret = read(conn, recvbuf.buf, n );　　<span class="comment">//再读取包体</span></span><br><span class="line">	    	<span class="keyword">if</span> ( ret == <span class="number">-1</span>) &#123; ERR_EXIT(<span class="string">"read"</span>);&#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                   <span class="keyword">if</span> (ret &lt; n )</span><br><span class="line">                   &#123;</span><br><span class="line">                           <span class="built_in">printf</span>(<span class="string">"client_close\n"</span>);</span><br><span class="line">                           <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">	    	<span class="built_in">fputs</span>(recvbuf.buf,<span class="built_in">stdout</span>);</span><br><span class="line">            write(conn,&amp;recvbuf,<span class="number">4</span>+n);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="keyword">int</span> listenfd;</span><br><span class="line">        <span class="keyword">if</span> ((listenfd = socket(PF_INET,SOCK_STREAM,IPPROTO_TCP)) &lt; <span class="number">0</span>)<span class="comment">//第三个参数也可直接是0</span></span><br><span class="line">		ERR_EXIT(<span class="string">"socket"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr,<span class="number">0</span>,<span class="keyword">sizeof</span> servaddr);</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = htons(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (setsockopt(listenfd,SOL_SOCKET,SO_REUSEADDR, &amp;on, <span class="keyword">sizeof</span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"setsockopt"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (bind(listenfd,(struct sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span> (servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"bind"</span>);</span><br><span class="line">	<span class="keyword">if</span> (listen(listenfd,SOMAXCONN) &lt; <span class="number">0</span> )</span><br><span class="line"> 		ERR_EXIT(<span class="string">"listen"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="keyword">sizeof</span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">        	<span class="keyword">if</span> ((conn = accept(listenfd,(struct sockaddr*)&amp;peeraddr,&amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">     			ERR_EXIT(<span class="string">"accept"</span>);</span><br><span class="line">	</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"ip = %s port = %d\n"</span>, inet_ntoa(peeraddr.sin_addr), ntohs(peeraddr.sin_port));</span><br><span class="line">	</span><br><span class="line">		pid = fork();</span><br><span class="line">		<span class="keyword">if</span> (pid == <span class="number">-1</span>) ERR_EXIT(<span class="string">"fork"</span>);</span><br><span class="line">		<span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			close(listenfd);</span><br><span class="line">			do_service(conn);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			close(conn);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) do &#123;  perror(m); exit(EXIT_FAILURE); &#125;while(0);</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">int</span> len;</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">ssize_t</span> readn(<span class="keyword">int</span> fd,<span class="keyword">void</span> *buf,<span class="keyword">size_t</span> count)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">size_t</span> nleft = count;</span><br><span class="line">        <span class="keyword">ssize_t</span> nread;</span><br><span class="line">        <span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*) buf;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(nleft &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span> ((nread = read(fd, bufp, nleft) )&lt; <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nread == <span class="number">0</span> )</span><br><span class="line">                         <span class="keyword">return</span> count - nleft;</span><br><span class="line"></span><br><span class="line">                bufp += nread;</span><br><span class="line">                nleft -= nread;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> writen(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">size_t</span> nleft = count;</span><br><span class="line">        <span class="keyword">ssize_t</span> nwritten;</span><br><span class="line">        <span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*) buf;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(nleft &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span> ((nwritten = write(fd, bufp, nleft) )&lt; <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nwritten  == <span class="number">0</span> )</span><br><span class="line">                         <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                bufp += nwritten;</span><br><span class="line">                nleft -= nwritten;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="keyword">int</span> sock;</span><br><span class="line">        <span class="keyword">if</span> ((sock  = socket(PF_INET,SOCK_STREAM,IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"socket"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr,<span class="number">0</span>,<span class="keyword">sizeof</span> servaddr);</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = htons(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (connect(sock, (struct sockaddr*)&amp;servaddr,<span class="keyword">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"connext"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet</span> <span class="title">sendbuf</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet</span> <span class="title">recvbuf</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sendbuf,<span class="number">0</span>,<span class="keyword">sizeof</span> sendbuf);</span><br><span class="line">        <span class="built_in">memset</span>(&amp;recvbuf,<span class="number">0</span>,<span class="keyword">sizeof</span> recvbuf);</span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">  	<span class="keyword">while</span>(fgets(sendbuf.buf ,<span class="keyword">sizeof</span> (sendbuf.buf),<span class="built_in">stdin</span>) != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		n = <span class="built_in">strlen</span>(sendbuf.buf);</span><br><span class="line">		sendbuf.len = htonl(n);</span><br><span class="line">		writen(sock,&amp;sendbuf,<span class="number">4</span>+n);</span><br><span class="line">		</span><br><span class="line">                <span class="keyword">int</span> ret = readn(sock, &amp;recvbuf.len, <span class="number">4</span>);</span><br><span class="line">                <span class="keyword">if</span> ( ret == <span class="number">-1</span>)&#123;  ERR_EXIT(<span class="string">"read"</span>);&#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> (ret &lt; <span class="number">4</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"client_close\n"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                n = ntohl(recvbuf.len);</span><br><span class="line">                ret = read(sock, recvbuf.buf, n );</span><br><span class="line">                <span class="keyword">if</span> ( ret == <span class="number">-1</span>) &#123; ERR_EXIT(<span class="string">"read"</span>);&#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> (ret &lt; n )</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"client_close\n"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf.buf,<span class="built_in">stdout</span>);</span><br><span class="line">		<span class="built_in">memset</span>(&amp;sendbuf,<span class="number">0</span>,<span class="keyword">sizeof</span> sendbuf);</span><br><span class="line">		<span class="built_in">memset</span>(&amp;recvbuf,<span class="number">0</span>,<span class="keyword">sizeof</span> recvbuf);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	close(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/19/点对点聊天程序/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Just_Lm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="條路自己揀，僕街唔好喊。">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/19/点对点聊天程序/" itemprop="url">点对点聊天程序</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-19T20:10:16+08:00">
                2018-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>功能：多进程实现服务器与客户端信息往来。</p>
</blockquote>
<h3 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) do &#123;  perror(m); exit(EXIT_FAILURE); &#125;while(0);</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"rev a sig = %d\n"</span>,sig);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="keyword">int</span> listenfd;</span><br><span class="line">        <span class="keyword">if</span> ((listenfd = socket(PF_INET,SOCK_STREAM,IPPROTO_TCP)) &lt; <span class="number">0</span>)<span class="comment">//第三个参数也可直接是0</span></span><br><span class="line">		ERR_EXIT(<span class="string">"socket"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr,<span class="number">0</span>,<span class="keyword">sizeof</span> servaddr);</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = htons(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (setsockopt(listenfd,SOL_SOCKET,SO_REUSEADDR, &amp;on, <span class="keyword">sizeof</span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"setsockopt"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (bind(listenfd,(struct sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span> (servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"bind"</span>);</span><br><span class="line">	<span class="keyword">if</span> (listen(listenfd,SOMAXCONN) &lt; <span class="number">0</span> )</span><br><span class="line"> 		ERR_EXIT(<span class="string">"listen"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="keyword">sizeof</span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">        <span class="keyword">if</span> ((conn = accept(listenfd,(struct sockaddr*)&amp;peeraddr,&amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">     		ERR_EXIT(<span class="string">"accept"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"ip = %s port = %d\n"</span>, inet_ntoa(peeraddr.sin_addr), ntohs(peeraddr.sin_port));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	pid = fork();</span><br><span class="line">	<span class="keyword">if</span> (pid == <span class="number">-1</span>)  ERR_EXIT(<span class="string">"fork"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pid == <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		signal(SIGUSR1,handler);</span><br><span class="line">		<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">		<span class="keyword">while</span>(fgets(sendbuf,<span class="keyword">sizeof</span>(sendbuf),<span class="built_in">stdin</span>) !=<span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			write(conn,sendbuf, <span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">			<span class="built_in">memset</span>(sendbuf,<span class="number">0</span>,<span class="keyword">sizeof</span> sendbuf );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"child close"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">		<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">memset</span>(recvbuf, <span class="number">0</span> , <span class="keyword">sizeof</span> recvbuf);</span><br><span class="line">			<span class="keyword">int</span> ret = read(conn, recvbuf, <span class="keyword">sizeof</span>(recvbuf));</span><br><span class="line">			<span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">			&#123; </span><br><span class="line">				ERR_EXIT(<span class="string">"read"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">				&#123; </span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"peer_close\n"</span>);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="built_in">fputs</span>(recvbuf,<span class="built_in">stdout</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"parent_close"</span>);</span><br><span class="line">		kill(pid,SIGUSR1);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">	&#125;</span><br><span class="line">	close(conn);</span><br><span class="line">	close(listenfd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) do &#123;  perror(m); exit(EXIT_FAILURE); &#125;while(0);</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"recv a sig = %d"</span>,sig);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="keyword">int</span> sock;</span><br><span class="line">        <span class="keyword">if</span> ((sock  = socket(PF_INET,SOCK_STREAM,IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"socket"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr,<span class="number">0</span>,<span class="keyword">sizeof</span> servaddr);</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = htons(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (connect(sock, (struct sockaddr*)&amp;servaddr,<span class="keyword">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"connext"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	pid = fork();</span><br><span class="line">	<span class="keyword">if</span> (pid == <span class="number">-1</span>) </span><br><span class="line">		ERR_EXIT(<span class="string">"fork"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">		<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">memset</span>(recvbuf, <span class="number">0</span> , <span class="keyword">sizeof</span> recvbuf);</span><br><span class="line">			<span class="keyword">int</span> ret = read(sock, recvbuf, <span class="keyword">sizeof</span> recvbuf );</span><br><span class="line">			<span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">			&#123; </span><br><span class="line">				ERR_EXIT(<span class="string">"read"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"peer close\n"</span>);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="built_in">fputs</span>(recvbuf,<span class="built_in">stdout</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		close(sock);</span><br><span class="line">		kill(getppid(),SIGUSR1);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">	&#123;</span><br><span class="line">		signal(SIGUSR1,handler);	</span><br><span class="line"> 		<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;	</span><br><span class="line">  		<span class="keyword">while</span>(fgets(sendbuf,<span class="keyword">sizeof</span> (sendbuf),<span class="built_in">stdin</span>) != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			write(sock,sendbuf,<span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">			<span class="built_in">memset</span>(sendbuf,<span class="number">0</span>,<span class="keyword">sizeof</span> sendbuf);</span><br><span class="line">		&#125;</span><br><span class="line">		close(sock);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="tip"><a href="#tip" class="headerlink" title="tip:"></a>tip:</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       getsockopt, setsockopt - get <span class="keyword">and</span> <span class="built_in">set</span> options on sockets</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;          /* See NOTES */</span></span></span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">getsockopt</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> level, <span class="keyword">int</span> optname,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">void</span> *optval, <span class="keyword">socklen_t</span> *optlen)</span></span>;</span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">setsockopt</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> level, <span class="keyword">int</span> optname,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">const</span> <span class="keyword">void</span> *optval, <span class="keyword">socklen_t</span> optlen)</span></span>;</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       getsockopt()   <span class="function"><span class="keyword">and</span>  <span class="title">setsockopt</span><span class="params">()</span>  manipulate  options  <span class="keyword">for</span>  the  socket</span></span><br><span class="line">       referred to by the file descriptor sockfd.  Options may exist at multi‐</span><br><span class="line">       ple  protocol  levels;  they are always present at the uppermost socket</span><br><span class="line">       level.</span><br><span class="line"></span><br><span class="line">       When manipulating socket options, the level at which the option resides</span><br><span class="line">       <span class="keyword">and</span> the name of the option must be specified.  To manipulate options at</span><br><span class="line">       the sockets API level, level is specified as SOL_SOCKET.  To manipulate</span><br><span class="line">       options  at any other level the protocol number of the appropriate pro‐</span><br><span class="line">       tocol controlling the option is supplied.   For  example,  to  indicate</span><br><span class="line">       that  an  option is to be interpreted by the TCP protocol, level should</span><br><span class="line">       be set to the protocol number of TCP; see getprotoent(3).</span><br><span class="line"></span><br><span class="line">       The arguments optval <span class="keyword">and</span> optlen are used to access  option  values  <span class="keyword">for</span></span><br><span class="line">       setsockopt().   <span class="function">For  <span class="title">getsockopt</span><span class="params">()</span>  they  identify a buffer in which the</span></span><br><span class="line">       value for the requested option(s) are to  be  returned.   For  getsock‐</span><br><span class="line">       opt(), optlen is a value-result argument, initially containing the size</span><br><span class="line">       of the buffer pointed to by optval, <span class="keyword">and</span> modified on <span class="keyword">return</span> to  indicate</span><br><span class="line">       the  actual  size  of  the value returned.  If no option value is to be</span><br><span class="line">       supplied <span class="keyword">or</span> returned, optval may be <span class="literal">NULL</span>.</span><br><span class="line"></span><br><span class="line">       Optname <span class="keyword">and</span> any specified  options  are  passed  uninterpreted  to  the</span><br><span class="line">       appropriate  protocol  <span class="keyword">module</span>  <span class="keyword">for</span>  interpretation.   The  include file</span><br><span class="line">       &lt;sys/socket.h&gt; contains definitions <span class="keyword">for</span> socket level options, described</span><br><span class="line">       below.   Options at other protocol levels vary in format <span class="keyword">and</span> name; con‐</span><br><span class="line">       sult the appropriate entries in section <span class="number">4</span> of the manual.</span><br><span class="line"></span><br><span class="line">       Most socket-level options utilize an <span class="keyword">int</span> argument <span class="keyword">for</span> optval.  For <span class="built_in">set</span>‐</span><br><span class="line">       sockopt(),  the  argument should be nonzero to enable a boolean option,</span><br><span class="line">       <span class="keyword">or</span> zero <span class="keyword">if</span> the option is to be disabled.</span><br><span class="line"></span><br><span class="line">       <span class="function">For a description of the available socket options see <span class="title">socket</span><span class="params">(<span class="number">7</span>)</span> <span class="keyword">and</span> the</span></span><br><span class="line">       appropriate protocol man pages.</span><br><span class="line"></span><br><span class="line">RETURN VALUE</span><br><span class="line">       On success, zero is returned <span class="keyword">for</span> the standard options.  On error, <span class="number">-1</span> is</span><br><span class="line">       returned, <span class="keyword">and</span> errno is <span class="built_in">set</span> appropriately.</span><br><span class="line"></span><br><span class="line">       Netfilter allows the programmer to define custom  socket  options  with</span><br><span class="line">       associated  handlers;  <span class="keyword">for</span> such options, the <span class="keyword">return</span> value on success is</span><br><span class="line">       the value returned by the handler.</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、一般来说，一个端口释放后会等待两分钟之后才能再被使用，SO_REUSEADDR是让端口释放后立即就可以被再次使用。</span><br><span class="line"></span><br><span class="line">    SO_REUSEADDR用于对TCP套接字处于TIME_WAIT状态下的socket，才可以重复绑定使用。server程序总是应该在调用bind()之前设置SO_REUSEADDR套接字选项。TCP，先调用close()的一方会进入TIME_WAIT状态</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、SO_REUSEADDR和SO_REUSEPORT</span><br><span class="line"></span><br><span class="line">SO_REUSEADDR提供如下四个功能：</span><br><span class="line"></span><br><span class="line">    SO_REUSEADDR允许启动一个监听服务器并捆绑其众所周知端口，即使以前建立的将此端口用做他们的本地端口的连接仍存在。这通常是重启监听服务器时出现，若不设置此选项，则bind时将出错。</span><br><span class="line"></span><br><span class="line">    SO_REUSEADDR允许在同一端口上启动同一服务器的多个实例，只要每个实例捆绑一个不同的本地IP地址即可。对于TCP，我们根本不可能启动捆绑相同IP地址和相同端口号的多个服务器。</span><br><span class="line"></span><br><span class="line">    SO_REUSEADDR允许单个进程捆绑同一端口到多个套接口上，只要每个捆绑指定不同的本地IP地址即可。这一般不用于TCP服务器。</span><br><span class="line"></span><br><span class="line">    SO_REUSEADDR允许完全重复的捆绑：当一个IP地址和端口绑定到某个套接口上时，还允许此IP地址和端口捆绑到另一个套接口上。一般来说，这个特性仅在支持多播的系统上才有，而且只对UDP套接口而言（TCP不支持多播）。</span><br><span class="line"></span><br><span class="line">SO_REUSEPORT选项有如下语义：</span><br><span class="line"></span><br><span class="line">    此选项允许完全重复捆绑，但仅在想捆绑相同IP地址和端口的套接口都指定了此套接口选项才行。</span><br><span class="line"></span><br><span class="line">    如果被捆绑的IP地址是一个多播地址，则SO_REUSEADDR和SO_REUSEPORT等效。</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       signal - ANSI C signal handling</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*<span class="keyword">sighandler_t</span>)</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">sighandler_t</span> signal(<span class="keyword">int</span> signum, <span class="keyword">sighandler_t</span> handler);</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       The behavior of signal() varies across UNIX versions, and has also varied historically across different versions of Linux.  Avoid its use: use sigaction(2) instead.  See Portability below.</span><br><span class="line"></span><br><span class="line">       signal() sets the disposition of the signal signum to handler, which is either SIG_IGN, SIG_DFL, or the address of a programmer-defined function (a "signal handler").</span><br><span class="line"></span><br><span class="line">       If the signal signum is delivered to the process, then one of the following happens:</span><br><span class="line"></span><br><span class="line">       *  If the disposition is <span class="built_in">set</span> to SIG_IGN, then the signal is ignored.</span><br><span class="line"></span><br><span class="line">       *  If the disposition is set to SIG_DFL, then the default action associated with the signal (see signal(7)) occurs.</span><br><span class="line"></span><br><span class="line">       *  If  the  disposition is set to a function, then first either the disposition is reset to SIG_DFL, or the signal is blocked (see Portability below), and then handler is called with argument</span><br><span class="line">          signum.  If invocation of the handler caused the signal to be blocked, then the signal is unblocked upon <span class="keyword">return</span> from the handler.</span><br><span class="line"></span><br><span class="line">       The signals SIGKILL <span class="keyword">and</span> SIGSTOP cannot be caught <span class="keyword">or</span> ignored.</span><br><span class="line"></span><br><span class="line">RETURN VALUE</span><br><span class="line">       signal() returns the previous value of the signal handler, <span class="keyword">or</span> SIG_ERR on error.  In the event of an error, errno is <span class="built_in">set</span> to indicate the cause.</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       kill - send signal to a process</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">kill</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> sig)</span></span>;</span><br><span class="line"></span><br><span class="line">   Feature Test Macro Requirements for glibc (see feature_test_macros(7)):</span><br><span class="line"></span><br><span class="line">       kill(): _POSIX_C_SOURCE &gt;= <span class="number">1</span> || _XOPEN_SOURCE || _POSIX_SOURCE</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       The kill() system call can be used to send any signal to any process group <span class="keyword">or</span> process.</span><br><span class="line"></span><br><span class="line">       If pid is positive, then signal sig is sent to the process with the ID specified by pid.</span><br><span class="line"></span><br><span class="line">       If pid equals <span class="number">0</span>, then sig is sent to every process in the process group of the calling process.</span><br><span class="line"></span><br><span class="line">       If pid equals <span class="number">-1</span>, then sig is sent to every process <span class="keyword">for</span> which the calling process has permission to send signals, except <span class="keyword">for</span> process <span class="number">1</span> (init), but see below.</span><br><span class="line"></span><br><span class="line">       If pid is less than <span class="number">-1</span>, then sig is sent to every process in the process group whose ID is -pid.</span><br><span class="line"></span><br><span class="line">       If sig is <span class="number">0</span>, then no signal is sent, but error checking is still performed; <span class="keyword">this</span> can be used to check <span class="keyword">for</span> the existence of a process ID <span class="keyword">or</span> process group ID.</span><br><span class="line"></span><br><span class="line">       For  a process to have permission to send a signal it must either be privileged (under Linux: have the CAP_KILL capability), or the real or effective user ID of the sending process must equal</span><br><span class="line">       the real <span class="keyword">or</span> saved <span class="built_in">set</span>-user-ID of the target process.  In the <span class="keyword">case</span> of SIGCONT it suffices when the sending <span class="keyword">and</span> receiving processes belong to the same session.  (Historically,  the  rules  were</span><br><span class="line">       different; see NOTES.)</span><br><span class="line"></span><br><span class="line">RETURN VALUE</span><br><span class="line">       On success (at least one signal was sent), zero is returned.  On error, -1 is returned, and errno is set appropriately.</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/19/简单的tcp客户端与服务端/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Just_Lm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="條路自己揀，僕街唔好喊。">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/19/简单的tcp客户端与服务端/" itemprop="url">简单的tcp客户端与服务端</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-19T01:44:44+08:00">
                2018-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>功能：客户端向服务器发送消息，服务器接收并显示。</p>
</blockquote>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) do &#123;  perror(m); exit(EXIT_FAILURE); &#125;while(0);</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="keyword">int</span> listenfd;</span><br><span class="line">        <span class="keyword">if</span> ((listenfd = socket(PF_INET,SOCK_STREAM,IPPROTO_TCP)) &lt; <span class="number">0</span>)<span class="comment">//第三个参数也可直接是0</span></span><br><span class="line">		ERR_EXIT(<span class="string">"socket"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr,<span class="number">0</span>,<span class="keyword">sizeof</span> servaddr);</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = htons(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (bind(listenfd,(struct sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span> (servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"bind"</span>);</span><br><span class="line">	<span class="keyword">if</span> (listen(listenfd,SOMAXCONN) &lt; <span class="number">0</span> )</span><br><span class="line"> 		ERR_EXIT(<span class="string">"listen"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="keyword">sizeof</span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">        <span class="keyword">if</span> ((conn = accept(listenfd,(struct sockaddr*)&amp;peeraddr,&amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">     		ERR_EXIT(<span class="string">"accept"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span> , <span class="keyword">sizeof</span> recvbuf);</span><br><span class="line">		<span class="keyword">int</span> ret = read(conn, recvbuf, <span class="keyword">sizeof</span>(recvbuf));</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf,<span class="built_in">stdout</span>);</span><br><span class="line">		write(conn,recvbuf,ret);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	close(conn);</span><br><span class="line">	close(listenfd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) do &#123;  perror(m); exit(EXIT_FAILURE); &#125;while(0);</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="keyword">int</span> sock;</span><br><span class="line">        <span class="keyword">if</span> ((sock  = socket(PF_INET,SOCK_STREAM,IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"socket"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr,<span class="number">0</span>,<span class="keyword">sizeof</span> servaddr);</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = htons(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (connect(sock, (struct sockaddr*)&amp;servaddr,<span class="keyword">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		ERR_EXIT(<span class="string">"connext"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  	<span class="keyword">while</span>(fgets(sendbuf,<span class="keyword">sizeof</span> (sendbuf),<span class="built_in">stdin</span>) != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		write(sock,sendbuf,<span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">		read(sock, recvbuf,<span class="keyword">sizeof</span>(recvbuf));</span><br><span class="line"></span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf,<span class="built_in">stdout</span>);</span><br><span class="line">		<span class="built_in">memset</span>(sendbuf,<span class="number">0</span>,<span class="keyword">sizeof</span> sendbuf);</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf,<span class="number">0</span>,<span class="keyword">sizeof</span> recvbuf);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	close(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>###tip:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       socket - create an endpoint <span class="keyword">for</span> communication</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;          /* See NOTES */</span></span></span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       socket()  creates  an endpoint <span class="keyword">for</span> communication <span class="keyword">and</span> returns a descrip‐</span><br><span class="line">       tor.</span><br><span class="line"></span><br><span class="line">       The domain argument specifies a communication domain; <span class="keyword">this</span> selects  the</span><br><span class="line">       protocol  family  which will be used <span class="keyword">for</span> communication.  These families</span><br><span class="line">       are  defined  in  &lt;sys/socket.h&gt;.   The  currently  understood  formats</span><br><span class="line">       include:</span><br><span class="line"></span><br><span class="line">       Name                Purpose                          Man page</span><br><span class="line">       AF_UNIX, <span class="function">AF_LOCAL   Local communication              <span class="title">unix</span><span class="params">(<span class="number">7</span>)</span></span></span><br><span class="line"><span class="function">       AF_INET             IPv4 Internet protocols          <span class="title">ip</span><span class="params">(<span class="number">7</span>)</span></span></span><br><span class="line"><span class="function">       AF_INET6            IPv6 Internet protocols          <span class="title">ipv6</span><span class="params">(<span class="number">7</span>)</span></span></span><br><span class="line">       AF_IPX              IPX - Novell protocols</span><br><span class="line">       <span class="function">AF_NETLINK          Kernel user interface device     <span class="title">netlink</span><span class="params">(<span class="number">7</span>)</span></span></span><br><span class="line">       AF_X25              ITU-T X.25 / ISO-8208 protocol   x25(7)</span><br><span class="line">       AF_AX25             Amateur radio AX<span class="number">.25</span> protocol</span><br><span class="line">       AF_ATMPVC           Access to raw ATM PVCs</span><br><span class="line">       <span class="function">AF_APPLETALK        AppleTalk                        <span class="title">ddp</span><span class="params">(<span class="number">7</span>)</span></span></span><br><span class="line"><span class="function">       AF_PACKET           Low level packet interface       <span class="title">packet</span><span class="params">(<span class="number">7</span>)</span></span></span><br><span class="line"><span class="function">       AF_ALG              Interface to kernel crypto API</span></span><br><span class="line"><span class="function"></span></span><br><span class="line">       The  socket  has  the indicated type, which specifies the communication</span><br><span class="line">       semantics.  Currently defined types are:</span><br><span class="line"></span><br><span class="line">       SOCK_STREAM     Provides sequenced, reliable, two-way, connection-based</span><br><span class="line">                       byte  streams.  An out-of-band data transmission mecha‐</span><br><span class="line">                       nism may be supported.</span><br><span class="line"></span><br><span class="line">       <span class="function">SOCK_DGRAM      Supports <span class="title">datagrams</span> <span class="params">(connectionless, unreliable messages</span></span></span><br><span class="line">                       of a fixed maximum length).</span><br><span class="line"></span><br><span class="line">       SOCK_SEQPACKET  Provides  a  sequenced,  reliable,  two-way connection-</span><br><span class="line">                       based data transmission path  <span class="keyword">for</span>  datagrams  of  fixed</span><br><span class="line">                       maximum  length;  a  consumer  is  required  to read an</span><br><span class="line">                       entire packet with each input system call.</span><br><span class="line"></span><br><span class="line">       SOCK_RAW        Provides raw network protocol access.</span><br><span class="line"></span><br><span class="line">       SOCK_RDM        Provides a reliable datagram layer that does <span class="keyword">not</span>  guar‐</span><br><span class="line">                       antee ordering.</span><br><span class="line"></span><br><span class="line">       SOCK_PACKET     Obsolete  <span class="keyword">and</span>  should  <span class="keyword">not</span> be used in <span class="keyword">new</span> programs; see</span><br><span class="line">                       packet(<span class="number">7</span>).</span><br><span class="line">                     </span><br><span class="line">                     </span><br><span class="line">RETURN VALUE</span><br><span class="line">       On success, a file descriptor <span class="keyword">for</span> the <span class="keyword">new</span> socket is returned.  On error, <span class="number">-1</span> is returned, <span class="keyword">and</span> errno is <span class="built_in">set</span> appropriately.</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span></span></span><br><span class="line"><span class="class"> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">short</span> sin_family;<span class="comment">/*Address family一般来说AF_INET（地址族）PF_INET（协议族）*/</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> sin_port;<span class="comment">/*Port number(必须要采用网络数据格式,普通数字可以用htons()函数转换成网络数据格式的数字)*/</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">sin_addr</span>;</span><span class="comment">/*IP address in network byte order（Internet address）*/</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> sin_zero[<span class="number">8</span>];<span class="comment">/*Same size as struct sockaddr没有实际意义,只是为了　跟SOCKADDR结构在内存中对齐*/</span></span><br><span class="line"> </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       htonl,  htons,  ntohl,  ntohs - convert values between host <span class="keyword">and</span> network</span><br><span class="line">       byte order</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">uint32_t</span> htonl(<span class="keyword">uint32_t</span> hostlong);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">uint16_t</span> htons(<span class="keyword">uint16_t</span> hostshort);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">uint32_t</span> ntohl(<span class="keyword">uint32_t</span> netlong);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">uint16_t</span> ntohs(<span class="keyword">uint16_t</span> netshort);</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       <span class="function">The <span class="title">htonl</span><span class="params">()</span> function converts the <span class="keyword">unsigned</span> integer hostlong  from  host</span></span><br><span class="line">       byte order to network byte order.</span><br><span class="line"></span><br><span class="line">       <span class="function">The <span class="title">htons</span><span class="params">()</span> function converts the <span class="keyword">unsigned</span> <span class="keyword">short</span> integer hostshort from</span></span><br><span class="line">       host byte order to network byte order.</span><br><span class="line"></span><br><span class="line">       <span class="function">The <span class="title">ntohl</span><span class="params">()</span> function converts the <span class="keyword">unsigned</span> integer netlong from network</span></span><br><span class="line">       byte order to host byte order.</span><br><span class="line"></span><br><span class="line">       <span class="function">The  <span class="title">ntohs</span><span class="params">()</span> function converts the <span class="keyword">unsigned</span> <span class="keyword">short</span> integer netshort from</span></span><br><span class="line">       network byte order to host byte order.</span><br><span class="line"></span><br><span class="line">       On the i386 the host  byte  order  is  Least  Significant  Byte  first,</span><br><span class="line">       whereas  the  network byte order, as used on the Internet, is Most Sig‐</span><br><span class="line">       nificant Byte first.</span><br><span class="line"></span><br><span class="line">ATTRIBUTES</span><br><span class="line">       For  an  explanation  of  the  terms  used   in   <span class="keyword">this</span>   section,   see</span><br><span class="line">       attributes(<span class="number">7</span>).</span><br><span class="line"></span><br><span class="line">       ┌───────────────────────────────────┬───────────────┬─────────┐</span><br><span class="line">       │Interface                          │ Attribute     │ Value   │</span><br><span class="line">       ├───────────────────────────────────┼───────────────┼─────────┤</span><br><span class="line">       │htonl(), htons(), ntohl(), ntohs() │ Thread safety │ MT-Safe │</span><br><span class="line">       └───────────────────────────────────┴───────────────┴─────────┘</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       inet_aton, inet_addr, inet_network, inet_ntoa, inet_makeaddr, inet_lnaof, inet_netof - Internet address manipulation routines</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">inet_aton</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *cp, struct in_addr *inp)</span></span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">in_addr_t</span> inet_addr(<span class="keyword">const</span> <span class="keyword">char</span> *cp);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">in_addr_t</span> inet_network(<span class="keyword">const</span> <span class="keyword">char</span> *cp);</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">char</span> *<span class="title">inet_ntoa</span><span class="params">(struct in_addr in)</span></span>;</span><br><span class="line"></span><br><span class="line">       <span class="function">struct in_addr <span class="title">inet_makeaddr</span><span class="params">(<span class="keyword">in_addr_t</span> net, <span class="keyword">in_addr_t</span> host)</span></span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">in_addr_t</span> inet_lnaof(struct in_addr in);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">in_addr_t</span> inet_netof(struct in_addr in);</span><br><span class="line"></span><br><span class="line">   Feature Test Macro Requirements for glibc (see feature_test_macros(7)):</span><br><span class="line"></span><br><span class="line">       inet_aton(), inet_ntoa(): _BSD_SOURCE || _SVID_SOURCE</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       inet_aton()  converts  the  Internet  host  address  cp  from  the  IPv4  numbers-and-dots notation into binary form (in network byte order) and stores it in the structure that inp points to.</span><br><span class="line">       inet_aton() returns nonzero <span class="keyword">if</span> the address is valid, zero <span class="keyword">if</span> <span class="keyword">not</span>.  The address supplied in cp can have one of the following forms:</span><br><span class="line"></span><br><span class="line">       a.b.c.d   Each of the four numeric parts specifies a byte of the address; the bytes are assigned in left-to-right order to produce the binary address.</span><br><span class="line"></span><br><span class="line">       a.b.c     Parts a <span class="keyword">and</span> b specify the first two bytes of the binary address.  Part c is interpreted as a <span class="number">16</span>-bit value that defines the rightmost two bytes of the binary address.  This  notation</span><br><span class="line">                 is suitable for specifying (outmoded) Class B network addresses.</span><br><span class="line"></span><br><span class="line">       a.b       Part a specifies the first byte of the binary address.  Part b is interpreted as a <span class="number">24</span>-bit value that defines the rightmost three bytes of the binary address.  This notation is suit‐</span><br><span class="line">                 able for specifying (outmoded) Class A network addresses.</span><br><span class="line"></span><br><span class="line">       a         The value a is interpreted as a <span class="number">32</span>-bit value that is stored directly into the binary address without any byte rearrangement.</span><br><span class="line"></span><br><span class="line">       In all of the above forms, components of the dotted address can be specified in decimal, octal (with a leading <span class="number">0</span>), <span class="keyword">or</span> hexadecimal, with a leading <span class="number">0</span>X).  Addresses in any  of  these  forms  are</span><br><span class="line">       collectively termed IPV4 numbers-and-dots notation.  The form that uses exactly four decimal numbers is referred to as IPv4 dotted-decimal notation (or sometimes: IPv4 dotted-quad notation).</span><br><span class="line"></span><br><span class="line">       inet_aton() returns 1 if the supplied string was successfully interpreted, or 0 if the string is invalid (errno is not set on error).</span><br><span class="line"></span><br><span class="line">       The  inet_addr()  function converts the Internet host address cp from IPv4 numbers-and-dots notation into binary data in network byte order.  If the input is invalid, INADDR_NONE (usually -1)</span><br><span class="line">       is returned.  Use of this function is problematic because -1 is a valid address (255.255.255.255).  Avoid its use in favor of inet_aton(), inet_pton(3), or  getaddrinfo(3),  which  provide  a</span><br><span class="line">       cleaner way to indicate error <span class="keyword">return</span>.</span><br><span class="line"></span><br><span class="line">       The  inet_network()  function  converts cp, a <span class="built_in">string</span> in IPv4 numbers-<span class="keyword">and</span>-dots notation, into a number in host byte order suitable <span class="keyword">for</span> use as an Internet network address.  On success, the con‐</span><br><span class="line">       verted address is returned.  If the input is invalid, <span class="number">-1</span> is returned.</span><br><span class="line"></span><br><span class="line">       The inet_ntoa() function converts the Internet host address in, given in network byte order, to a <span class="built_in">string</span> in IPv4 dotted-decimal notation.  The <span class="built_in">string</span> is returned  in  a  statically  allocated</span><br><span class="line">       buffer, which subsequent calls will overwrite.</span><br><span class="line"></span><br><span class="line">       The inet_lnaof() function returns the local network address part of the Internet address in.  The returned value is in host byte order.</span><br><span class="line"></span><br><span class="line">       The inet_netof() function returns the network number part of the Internet address in.  The returned value is in host byte order.</span><br><span class="line"></span><br><span class="line"> The inet_makeaddr() function is the converse of inet_netof() <span class="keyword">and</span> inet_lnaof().  It returns an Internet host address in network byte order, created by combining the network number net with the</span><br><span class="line">       local address host, both in host byte order.</span><br><span class="line"></span><br><span class="line">       The structure in_addr as used in inet_ntoa(), inet_makeaddr(), inet_lnaof() <span class="keyword">and</span> inet_netof() is defined in &lt;netinet/in.h&gt; as:</span><br><span class="line"></span><br><span class="line">           <span class="keyword">typedef</span> <span class="keyword">uint32_t</span> <span class="keyword">in_addr_t</span>;</span><br><span class="line"></span><br><span class="line">           <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> &#123;</span></span><br><span class="line">               <span class="keyword">in_addr_t</span> s_addr;</span><br><span class="line">           &#125;;</span><br><span class="line"></span><br><span class="line">ATTRIBUTES</span><br><span class="line">       For an explanation of the terms used in this section, see attributes(7).</span><br><span class="line"></span><br><span class="line">       ┌───────────────────────────────┬───────────────┬────────────────┐</span><br><span class="line">       │Interface                      │ Attribute     │ Value          │</span><br><span class="line">       ├───────────────────────────────┼───────────────┼────────────────┤</span><br><span class="line">       │inet_aton(), inet_addr(),      │ Thread safety │ MT-Safe locale │</span><br><span class="line">       │inet_network(), inet_ntoa()    │               │                │</span><br><span class="line">       ├───────────────────────────────┼───────────────┼────────────────┤</span><br><span class="line">       │inet_makeaddr(), inet_lnaof(), │ Thread safety │ MT-Safe        │</span><br><span class="line">       │inet_netof()                   │               │                │</span><br><span class="line">       └───────────────────────────────┴───────────────┴────────────────┘</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">INADDR_ANY选项</span><br><span class="line">    网络编程中常用到bind函数，需要绑定IP地址，这时可以设置INADDR_ANY</span><br><span class="line">    INADDR_ANY就是指定地址为<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>的地址，这个地址事实上表示不确定地址，或“所有地址”、“任意地址”。</span><br><span class="line">也就是表示本机的所有IP，因为有些机子不止一块网卡，多网卡的情况下，这个就表示所有网卡ip地址的意思。</span><br><span class="line">    比如一台电脑有<span class="number">3</span>块网卡，分别连接三个网络，那么这台电脑就有<span class="number">3</span>个ip地址了，如果某个应用程序需要监听某</span><br><span class="line">个端口，那他要监听哪个网卡地址的端口呢？如果绑定某个具体的ip地址，你只能监听你所设置的ip地址所在的网</span><br><span class="line">卡的端口，其它两块网卡无法监听端口，如果我需要三个网卡都监听，那就需要绑定<span class="number">3</span>个ip，也就等于需要管理<span class="number">3</span>个</span><br><span class="line">套接字进行数据交换，这样岂不是很繁琐？</span><br><span class="line">    所以你只需绑定INADDR_ANY，管理一个套接字就行，不管数据是从哪个网卡过来的，</span><br><span class="line">只要是绑定的端口号过来的数据，都可以接收到。</span><br><span class="line"></span><br><span class="line">    当然， 客户端connect时，不能使用INADDR_ANY选项。必须指明要连接哪个服务器IP。</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       bind - bind a name to a socket</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;          /* See NOTES */</span></span></span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">bind</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> struct sockaddr *addr,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">socklen_t</span> addrlen)</span></span>;</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       When  a socket is created with socket(2), it exists in a name space (address family) but has no address assigned to it.  bind() assigns the address specified by addr to the socket referred to</span><br><span class="line">       by the file descriptor sockfd.  addrlen specifies the size, in bytes, of the address structure pointed to by addr.  Traditionally, <span class="keyword">this</span> operation is called “assigning a name to a socket”.</span><br><span class="line"></span><br><span class="line">       It is normally necessary to assign a local address using bind() before a SOCK_STREAM socket may receive connections (see accept(2)).</span><br><span class="line"></span><br><span class="line">       The rules used in name binding vary between address families.  Consult the manual entries in Section 7 for detailed information.  For AF_INET see ip(7), for AF_INET6 see ipv6(7), for  AF_UNIX</span><br><span class="line">       see unix(7), for AF_APPLETALK see ddp(7), for AF_PACKET see packet(7), for AF_X25 see x25(7) and for AF_NETLINK see netlink(7).</span><br><span class="line"></span><br><span class="line">       The actual structure passed <span class="keyword">for</span> the addr argument will depend on the address family.  The sockaddr structure is defined as something like:</span><br><span class="line"></span><br><span class="line">           <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> &#123;</span></span><br><span class="line">               <span class="keyword">sa_family_t</span> sa_family;</span><br><span class="line">               <span class="keyword">char</span>        sa_data[<span class="number">14</span>];</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       The only purpose of <span class="keyword">this</span> structure is to cast the structure pointer passed in addr in order to avoid compiler warnings.  See EXAMPLE below.</span><br><span class="line"></span><br><span class="line">RETURN VALUE</span><br><span class="line">       On success, zero is returned.  On error, <span class="number">-1</span> is returned, <span class="keyword">and</span> errno is <span class="built_in">set</span> appropriately.</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       listen - listen <span class="keyword">for</span> connections on a socket</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;          /* See NOTES */</span></span></span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">listen</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> backlog)</span></span>;</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       listen() marks the socket referred to by sockfd as a passive socket, that is, as a socket that will be used to accept incoming connection requests using accept(2).</span><br><span class="line"></span><br><span class="line">       The sockfd argument is a file descriptor that refers to a socket of type SOCK_STREAM <span class="keyword">or</span> SOCK_SEQPACKET.</span><br><span class="line"></span><br><span class="line">       The  backlog argument defines the maximum length to which the <span class="built_in">queue</span> of pending connections <span class="keyword">for</span> sockfd may grow.  If a connection request arrives when the <span class="built_in">queue</span> is full, the client may receive</span><br><span class="line">       an error with an indication of ECONNREFUSED <span class="keyword">or</span>, <span class="keyword">if</span> the underlying protocol supports retransmission, the request may be ignored so that a later reattempt at connection succeeds.</span><br><span class="line"></span><br><span class="line">RETURN VALUE</span><br><span class="line">       On success, zero is returned.  On error, <span class="number">-1</span> is returned, <span class="keyword">and</span> errno is <span class="built_in">set</span> appropriately.</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">对于一个TCP连接，Server与Client需要通过三次握手来建立网络连接.当三次握手成功后,</span><br><span class="line"></span><br><span class="line">　　我们可以看到端口的状态由LISTEN转变为ESTABLISHED,接着这条链路上就可以开始传送数据了.</span><br><span class="line"></span><br><span class="line">　　每一个处于监听(Listen)状态的端口,都有自己的监听队列.监听队列的长度,与如下两方面有关:</span><br><span class="line"></span><br><span class="line">　　- somaxconn参数.</span><br><span class="line"></span><br><span class="line">　　- 使用该端口的程序中listen()函数.</span><br><span class="line"></span><br><span class="line">　　<span class="number">1.</span> 关于somaxconn参数:</span><br><span class="line"></span><br><span class="line">　　定义了系统中每一个端口最大的监听队列的长度,这是个全局的参数,默认值为<span class="number">1024</span>,具体信息为:</span><br><span class="line"></span><br><span class="line">　　Purpose:</span><br><span class="line"></span><br><span class="line">　　Specifies the maximum listen backlog.</span><br><span class="line"></span><br><span class="line">　　Values:</span><br><span class="line"></span><br><span class="line">　　Default: <span class="number">1024</span> connections</span><br><span class="line"></span><br><span class="line">　　Range: <span class="number">0</span> to MAXSHORT</span><br><span class="line"></span><br><span class="line">　　Type: Connect</span><br><span class="line"></span><br><span class="line">　　Diagnosis:</span><br><span class="line"></span><br><span class="line">　　N/A</span><br><span class="line"></span><br><span class="line">　　Tuning</span><br><span class="line"></span><br><span class="line">　　Increase <span class="keyword">this</span> parameter on busy Web servers to handle peak connection rates.</span><br><span class="line"></span><br><span class="line">　　看下FREEBSD的解析：</span><br><span class="line"></span><br><span class="line">　　限制了接收新 TCP 连接侦听队列的大小。对于一个经常处理新连接的高负载 web服务环境来说，默认的 <span class="number">128</span> 太小了。大多数环境这个值建议增加到 <span class="number">1024</span> 或者更多。 服务进程会自己限制侦听队列的大小(例如 sendmail(<span class="number">8</span>) 或者 Apache)，常常在它们的配置文件中有设置队列大小的选项。大的侦听队列对防止拒绝服务 DoS 攻击也会有所帮助。</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       accept, accept4 - accept a connection on a socket</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;          /* See NOTES */</span></span></span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *addr, <span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br><span class="line"></span><br><span class="line">       <span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE             <span class="comment">/* See feature_test_macros(7) */</span></span></span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">accept4</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *addr,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">socklen_t</span> *addrlen, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       The  accept()  system call is used with connection-based socket types (SOCK_STREAM, SOCK_SEQPACKET).  It extracts the first connection request on the queue of pending connections for the lis‐</span><br><span class="line">       tening socket, sockfd, creates a <span class="keyword">new</span> connected socket, <span class="keyword">and</span> returns a <span class="keyword">new</span> file descriptor referring to that socket.  The newly created socket is <span class="keyword">not</span>  in  the  listening  state.   The  original</span><br><span class="line">       socket sockfd is unaffected by <span class="keyword">this</span> call.</span><br><span class="line"></span><br><span class="line">       The argument sockfd is a socket that has been created with socket(<span class="number">2</span>), bound to a local address with bind(<span class="number">2</span>), <span class="keyword">and</span> is listening <span class="keyword">for</span> connections after a listen(<span class="number">2</span>).</span><br><span class="line"></span><br><span class="line">       The  argument  addr  is  a  pointer  to  a sockaddr structure.  This structure is filled in with the address of the peer socket, as known to the communications layer.  The exact format of the</span><br><span class="line">       address returned addr is determined by the socket ‘s address family (see socket(<span class="number">2</span>) <span class="keyword">and</span> the respective protocol man pages).  When addr is <span class="literal">NULL</span>, nothing is filled in; in <span class="keyword">this</span>  <span class="keyword">case</span>,  addrlen  is</span><br><span class="line">       <span class="keyword">not</span> used, <span class="keyword">and</span> should also be <span class="literal">NULL</span>.</span><br><span class="line"></span><br><span class="line">       The addrlen argument is a value-result argument: <span class="function">the caller must initialize it to contain the <span class="title">size</span> <span class="params">(in bytes)</span> of the structure pointed to by addr</span>; on <span class="keyword">return</span> it will contain the actual size of</span><br><span class="line">       the peer address.</span><br><span class="line"></span><br><span class="line">       The returned address is truncated <span class="keyword">if</span> the buffer provided is too small; in <span class="keyword">this</span> <span class="keyword">case</span>, addrlen will <span class="keyword">return</span> a value greater than was supplied to the call.</span><br><span class="line"></span><br><span class="line">       If no pending connections are present on the <span class="built_in">queue</span>, <span class="keyword">and</span> the socket is <span class="keyword">not</span> marked as nonblocking, accept() blocks the caller until a connection is present.  If the socket is marked nonblocking</span><br><span class="line">       <span class="keyword">and</span> no pending connections are present on the <span class="built_in">queue</span>, accept() fails with the error EAGAIN <span class="keyword">or</span> EWOULDBLOCK.</span><br><span class="line"></span><br><span class="line">       In  order  to  be  notified of incoming connections on a socket, you can use select(<span class="number">2</span>) <span class="keyword">or</span> poll(<span class="number">2</span>).  A readable event will be delivered when a <span class="keyword">new</span> connection is attempted <span class="keyword">and</span> you may then call</span><br><span class="line">       accept() to get a socket for that connection.  Alternatively, you can set the socket to deliver SIGIO when activity occurs on a socket; see socket(7) for details.</span><br><span class="line"></span><br><span class="line">       For certain protocols which require an <span class="keyword">explicit</span> confirmation, such as DECNet, accept() can be thought of as merely dequeuing the next connection request <span class="keyword">and</span> <span class="keyword">not</span> implying  confirmation.   Con‐</span><br><span class="line">       firmation can be implied by a normal read <span class="keyword">or</span> write on the <span class="keyword">new</span> file descriptor, <span class="keyword">and</span> rejection can be implied by closing the <span class="keyword">new</span> socket.  Currently only DECNet has these semantics on Linux.</span><br><span class="line"></span><br><span class="line">       If flags is <span class="number">0</span>, then accept4() is the same as accept().  The following values can be bitwise ORed in flags to obtain different behavior:</span><br><span class="line"></span><br><span class="line">       SOCK_NONBLOCK   Set the O_NONBLOCK file status flag on the <span class="keyword">new</span> open file description.  Using <span class="keyword">this</span> flag saves extra calls to fcntl(<span class="number">2</span>) to achieve the same result.</span><br><span class="line"></span><br><span class="line">       SOCK_CLOEXEC    Set the close-on-exec (FD_CLOEXEC) flag on the <span class="keyword">new</span> file descriptor.  See the description of the O_CLOEXEC flag in open(<span class="number">2</span>) <span class="keyword">for</span> reasons why <span class="keyword">this</span> may be useful.</span><br><span class="line"></span><br><span class="line">RETURN VALUE</span><br><span class="line">       On success, these system calls <span class="keyword">return</span> a nonnegative integer that is a descriptor <span class="keyword">for</span> the accepted socket.  On error, <span class="number">-1</span> is returned, <span class="keyword">and</span> errno is <span class="built_in">set</span> appropriately.</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       read - read from a file descriptor</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">ssize_t</span> read(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count);</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       read() attempts to read up to count bytes from file descriptor fd into the buffer starting at buf.</span><br><span class="line"></span><br><span class="line">       On  files  that  support seeking, the read operation commences at the current file offset, <span class="keyword">and</span> the file offset is incremented by the number of bytes read.  If the current file offset is at <span class="keyword">or</span></span><br><span class="line">       past the end of file, no bytes are read, and read() returns zero.</span><br><span class="line"></span><br><span class="line">       If count is zero, read() may detect the errors described below.  In the absence of any errors, or if read() does not check for errors, a read() with a count of 0 returns zero and has no other</span><br><span class="line">       effects.</span><br><span class="line"></span><br><span class="line">       If count is greater than SSIZE_MAX, the result is unspecified.</span><br><span class="line"></span><br><span class="line">RETURN VALUE</span><br><span class="line">       On  success, the number of bytes read is returned (zero indicates end of file), and the file position is advanced by this number.  It is not an error if this number is smaller than the number</span><br><span class="line">       of bytes requested; <span class="function"><span class="keyword">this</span> may happen <span class="keyword">for</span> example because fewer bytes are actually available right <span class="title">now</span> <span class="params">(maybe because we were close to end-of-file, <span class="keyword">or</span> because we are reading  from  a  pipe,  <span class="keyword">or</span></span></span></span><br><span class="line">       from a terminal), or because read() was interrupted by a signal.  See also NOTES.</span><br><span class="line"></span><br><span class="line">       On error, -1 is returned, and errno is set appropriately.  In this case, it is left unspecified whether the file position (if any) changes.</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       write - write to a file descriptor</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">ssize_t</span> write(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count);</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       write() writes up to count bytes from the buffer pointed buf to the file referred to by the file descriptor fd.</span><br><span class="line"></span><br><span class="line">       The number of bytes written may be less than count <span class="keyword">if</span>, <span class="keyword">for</span> example, there is insufficient space on the underlying physical medium, <span class="function"><span class="keyword">or</span> the RLIMIT_FSIZE resource limit is <span class="title">encountered</span> <span class="params">(see setr‐</span></span></span><br><span class="line">       limit(2)), or the call was interrupted by a signal handler after having written less than count bytes.  (See also pipe(7).)</span><br><span class="line"></span><br><span class="line">       For a seekable file (i.e., one to which lseek(2) may be applied, for example, a regular file) writing takes place at the current file offset, and the file offset is incremented by the  number</span><br><span class="line">       of bytes actually written.  If the file was open(2)ed with O_APPEND, the file offset is first set to the end of the file before writing.  The adjustment of the file offset and the write oper‐</span><br><span class="line">       ation are performed as an atomic step.</span><br><span class="line"></span><br><span class="line">       POSIX requires that a read(2) which can be proved to occur after a write() has returned returns the new data.  Note that not all filesystems are POSIX conforming.</span><br><span class="line"></span><br><span class="line">RETURN VALUE</span><br><span class="line">       On success, the number of bytes written is returned (zero indicates nothing was written).  It is not an error if this number is smaller than the number of bytes requested; this may happen for</span><br><span class="line">       example because the disk device was filled.  See also NOTES.</span><br><span class="line"></span><br><span class="line">       On error, <span class="number">-1</span> is returned, <span class="keyword">and</span> errno is <span class="built_in">set</span> appropriately.</span><br><span class="line"></span><br><span class="line">       If  count  is zero and fd refers to a regular file, then write() may return a failure status if one of the errors below is detected.  If no errors are detected, or error detection is not per‐</span><br><span class="line">       formed, <span class="number">0</span> will be returned without causing any other effect.  If count is zero <span class="keyword">and</span> fd refers to a file other than a regular file, the results are <span class="keyword">not</span> specified.</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/09/CSDN blog/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Just_Lm">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="條路自己揀，僕街唔好喊。">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/09/CSDN blog/" itemprop="url">CSDN blog</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-09T00:03:30+08:00">
                2018-02-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="CSDN-blog"><a href="#CSDN-blog" class="headerlink" title="CSDN blog:"></a>CSDN blog:</h3><p>———————-<a href="http://blog.csdn.net/just_lm" target="_blank" rel="noopener">传送门</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/1.jpg"
                alt="Just_Lm" />
            
              <p class="site-author-name" itemprop="name">Just_Lm</p>
              <p class="site-description motion-element" itemprop="description">c++后台方向</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Just_Lm</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  









  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three-waves.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
